Triggers:

Costo ->

CREATE TRIGGER [dbo].[trigger_actualizar_costo]
ON [dbo].[Costos]
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Actualizar valor_total en la tabla Costos
    UPDATE Costos
    SET valor_total = (desperdicio + total_cantidad) * valor_unitario
    WHERE id_producto IN (SELECT id_producto FROM inserted);

    -- Actualizar costo en la tabla Productos
    UPDATE Productos
    SET costo = (
        SELECT SUM(c.valor_total)
        FROM Costos AS c
        WHERE c.id_producto = Productos.id_producto
    )
    WHERE Productos.id_producto IN (SELECT id_producto FROM inserted);
END;


CostoMateriasPrimas ->

CREATE TRIGGER [dbo].[trg_actualizar_costos]
ON [dbo].[CostosMateriasPrimas]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE costos
    SET valor_unitario = i.valor,
        cantidad_desperdicio = i.desperdicio_cantidad,
		cm = i.medida
    FROM costos c
    INNER JOIN inserted i ON c.id_materia_prima = i.id_materia_prima;
END;



MANO OBRA ->

CREATE TRIGGER trg_ActualizarPorcentaje
ON ManoObra
AFTER UPDATE
AS
BEGIN
    IF UPDATE(costo) OR UPDATE(total_cantidad) -- Verifica si se han actualizado las columnas relevantes
    BEGIN
        DECLARE @id_producto INT;

        -- Obtiene el ID del producto que se ha actualizado
        SELECT @id_producto = id_producto FROM inserted;

        -- Actualiza el porcentaje para el producto actualizado
        UPDATE ManoObra
        SET costo = (SELECT ISNULL(SUM(costo), 0) FROM ManoObra WHERE id_producto = @id_producto AND id_tipo_mano_obra NOT IN (1, 4)),
            total_cantidad = 0.12,
            valor_total = 0.12 * (SELECT ISNULL(SUM(costo), 0) FROM ManoObra WHERE id_producto = @id_producto AND id_tipo_mano_obra NOT IN (1, 4)),
            fecha = GETDATE()
        WHERE id_producto = @id_producto AND id_tipo_mano_obra = 4;

        -- Si no hay ninguna fila con id_tipo_mano_obra = 4, insertar una nueva fila
        IF @@ROWCOUNT = 0
        BEGIN
            INSERT INTO ManoObra (id_producto, id_tipo_mano_obra, costo, total_cantidad, valor_total, fecha)
            VALUES (@id_producto, 4, (SELECT ISNULL(SUM(costo), 0) FROM ManoObra WHERE id_producto = @id_producto AND id_tipo_mano_obra NOT IN (1, 4)), 0.12, 0.12 * (SELECT ISNULL(SUM(costo), 0) FROM ManoObra WHERE id_producto = @id_producto AND id_tipo_mano_obra NOT IN (1, 4)), GETDATE());
        END
    END
END;

